var HOUR_OFFSET=12,wc_appointments_date_picker={};jQuery(function(l){"use strict";var y,g,H={},t=window.navigator.userLanguage||window.navigator.language,o={init:function(){l("body").on("change","#wc_appointments_field_staff",this.staff_calendar),l("body").on("click",".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date",this.toggle_calendar),l("body").on("click",".appointment_date_year, .appointment_date_month, .appointment_date_day",this.open_calendar),l("body").on("input",".appointment_date_year, .appointment_date_month, .appointment_date_day",this.input_date_trigger),l("body").on("change",".appointment_to_date_year, .appointment_to_date_month, .appointment_to_date_day",this.input_date_trigger),l(".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date").show(),l(".wc-appointments-date-picker").each(function(){var s=l(this).closest("form"),r=s.find(".picker:eq(0)"),t=l(this).closest("fieldset"),a=r.attr("data-duration_unit");-1===l.inArray(a,["minute","hour"])&&s.on("addon-duration-changed",function(t,a){var e=parseInt(r.attr("data-appointment_duration"),10),i=parseInt(a,10),n=parseInt(e+i,10);r.data("combined_duration",n),r.data("addon_duration",a),wc_appointments_date_picker.highlight_days(s)}),wc_appointments_date_picker.date_picker_init(r),l(".wc-appointments-date-picker-date-fields",t).hide(),l(".wc-appointments-date-picker-choose-date",t).hide()})},highlight_days:function(t){var a=t.find(".picker"),e=a.find("td.ui-datepicker-current-day").not(".ui-state-disabled"),i=a.attr("data-appointment_duration"),n=a.data("combined_duration")?a.data("combined_duration"):i,s=(n<1?1:n)-1;a.find("td").removeClass("ui-datepicker-selected-day"),0<s&&e.nextAll("td").add(e.closest("tr").nextAll().find("td")).slice(0,s).addClass("ui-datepicker-selected-day")},staff_calendar:function(){var t=l(this).closest("form").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t)},toggle_calendar:function(){var t=l(this).closest("fieldset").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t),t.slideToggle()},open_calendar:function(){var t=l(this).closest("fieldset").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t),t.slideDown()},input_date_trigger:function(){var t=l(this).closest("fieldset"),a=t.find(".picker:eq(0)"),e=parseInt(t.find("input.appointment_date_year").val(),10),i=parseInt(t.find("input.appointment_date_month").val(),10),n=parseInt(t.find("input.appointment_date_day").val(),10);if(e&&i&&n){var s=new Date(e,i-1,n);a.datepicker("setDate",s)}},select_date_trigger:function(t){var a=l(this).closest("fieldset"),e=a.closest("form"),i=e.find(".picker:eq(0)"),n=t.split("-"),s=parseInt(n[0],10),r=parseInt(n[1],10),d=parseInt(n[2],10),_=i.attr("data-duration_unit"),o=i.attr("data-appointment_duration"),c=i.data("combined_duration")?i.data("combined_duration"):o;if(-1===l.inArray(_,["minute","hour"])){var p=c<1?1:c;y=new Date(s,r-1,d),g=new Date(s,r-1,d+(parseInt(p,10)-1))}a.find("input.appointment_to_date_year").val(""),a.find("input.appointment_to_date_month").val(""),a.find("input.appointment_to_date_day").val(""),a.find("input.appointment_date_year").val(n[0]),a.find("input.appointment_date_month").val(n[1]),a.find("input.appointment_date_day").val(n[2]).change(),e.find(".wc-appointments-appointment-form-button").prop("disabled",!0),e.triggerHandler("date-selected",t)},date_picker_init:function(e){var t=new i(e),a=t.get_data_attr("default_date");null!==wca_get_querystring("date")&&wca_is_valid_date(wca_get_querystring("date"))&&(a=wca_get_querystring("date")),t.set_default_params({onSelect:wc_appointments_date_picker.select_date_trigger,minDate:t.get_data_attr("min_date"),maxDate:t.get_data_attr("max_date"),defaultDate:a,changeMonth:t.get_custom_data("changeMonth"),changeYear:t.get_custom_data("changeYear"),showWeek:t.get_custom_data("showWeek"),showOn:t.get_custom_data("showOn"),numberOfMonths:parseInt(t.get_custom_data("numberOfMonths")),showButtonPanel:t.get_custom_data("showButtonPanel"),showOtherMonths:t.get_custom_data("showOtherMonths"),selectOtherMonths:t.get_custom_data("selectOtherMonths"),gotoCurrent:t.get_custom_data("gotoCurrent"),closeText:t.get_custom_data("closeText"),currentText:t.get_custom_data("currentText"),prevText:t.get_custom_data("prevText"),nextText:t.get_custom_data("nextText"),monthNames:t.get_custom_data("monthNames"),monthNamesShort:t.get_custom_data("monthNamesShort"),dayNames:t.get_custom_data("dayNames"),dayNamesMin:t.get_custom_data("dayNamesShort"),firstDay:t.get_custom_data("firstDay"),isRTL:t.get_custom_data("isRTL"),beforeShowDay:t.maybe_load_from_cache.bind(t),onChangeMonthYear:function(t,a){this.get_data(t,a).done(function(){e.datepicker("refresh")})}.bind(t)}),t.create(),wc_appointments_date_picker.get_day_attributes=t.maybe_load_from_cache.bind(t)},refresh_datepicker:function(){l(".wc-appointments-date-picker").find(".picker:eq(0)").datepicker("refresh")},get_number_of_days:function(t,a,e){var i=t,n=e.attr("data-duration_unit"),s=e.attr("data-appointment_duration"),r=e.data("combined_duration")?e.data("combined_duration"):s,d=e.attr("data-availability_span");return-1===l.inArray(n,["minute","hour"])&&(i=r<1?1:r),(i<1||"start"===d)&&(i=1),i},is_slot_appointable:function(t){for(var a=t.default_availability,e=0;e<t.number_of_days;e++){var i=new Date(t.start_date);i.setDate(i.getDate()+e);var n=i.getFullYear(),s=i.getMonth()+1,r=i.getDate(),d=i.getDay(),_=n+"-"+s+"-"+r;0===d&&(d=7);var o={date:i,staff_id:t.staff_id,default_availability:t.default_availability,availability:t.availability};if(a=wc_appointments_date_picker.is_staff_available_on_date(o),"all"===t.staff_assignment&&t.has_staff&&1<t.has_staff){var c=l.extend({availability:t.availability,fully_scheduled_days:t.fully_scheduled_days},o);a=wc_appointments_date_picker.has_all_available_staff(c)}else if(0===t.staff_id&&t.has_staff&&1<t.has_staff){var p=l.extend({availability:t.availability,fully_scheduled_days:t.fully_scheduled_days,staff_count:t.has_staff,has_staff_ids:t.has_staff_ids},o);a=wc_appointments_date_picker.has_any_available_staff(p)}if(t.fully_scheduled_days[_]&&(t.fully_scheduled_days[_][0]||t.fully_scheduled_days[_][t.staff_id])&&(a=!1),!a)break}return a},rrule_cache:{},is_staff_available_on_date:function(P){if("object"!=typeof P||"object"!=typeof P.availability)return!1;var t=P.default_availability,Y=P.date.getFullYear(),T=P.date.getMonth()+1,j=P.date.getDate(),q=P.date.getDay(),a=Y+"-"+T+"-"+j,S=parseInt(P.staff_id),A=moment.utc(P.date).isoWeek();0===q&&(q=7);var C=[];if(P.fully_scheduled_days&&P.fully_scheduled_days[a]&&P.fully_scheduled_days[a][S])return C;var E=_.range(1,1440,1);return t&&(C=E),l.each(P.availability,function(t,a){var s,e=a.type,r=a.range,i=a.level,n=parseInt(a.kind_id);if(Array.isArray(r))return!0;if(void 0!==S&&S&&0!==S&&"staff"===i&&S!==n)return!0;try{switch(e){case"months":if("undefined"!=typeof r[T])return C=r[T]?E:[],!0;break;case"weeks":if("undefined"!=typeof r[A])return C=r[A]?E:[],!0;break;case"days":if("undefined"!=typeof r[q])return C=r[q]?E:[],!0;break;case"custom":if("undefined"!=typeof r[Y][T][j])return C=r[Y][T][j]?E:[],!0;break;case"rrule":var d=-1===r.from.indexOf(":"),o=moment.utc(P.date).clone().startOf("day"),c=moment.utc(r.from),p=d?moment.utc(r.to).add(1,"days"):moment.utc(r.to),l=moment.duration(p.diff(c)),u=rrule.rrulestr(r.rrule,{dtstart:c.toDate()}),m=t+H.startDate+H.endDate;"undefined"==typeof wc_appointments_date_picker.rrule_cache[m]&&(wc_appointments_date_picker.rrule_cache[m]=u.between(moment.utc(H.startDate).subtract(l).subtract(1,"days").toDate(),moment.utc(H.endDate).subtract(l).add(1,"days").toDate(),!0).map(function(t){return new moment(t)})),wc_appointments_date_picker.rrule_cache[m].forEach(function(t){var a=t.clone().startOf("day"),e=t.clone().add(l),i=e.clone().startOf("day");if(o.isSameOrAfter(a)&&o.isBefore(i))if(d)C=r.rule?E:[];else if(o.isSame(a)){var n=moment.duration(t.diff(a)).asMinutes();s=_.range(n,n+l.asMinutes(),1),C=r.rule?_.union(C,s):_.difference(C,s)}else o.isAfter(a)&&o.isBefore(i)?C=r.rule?E:[]:o.isSame(i)&&(s=_.range(1,moment.duration(e.diff(i)).asMinutes(),1),C=r.rule?_.union(C,s):_.difference(C,s))});break;case"time":case"time:1":case"time:2":case"time:3":case"time:4":case"time:5":case"time:6":case"time:7":var f=parseInt(r.from.split(":")[0]),h=parseInt(r.from.split(":")[1])+60*f,y=parseInt(r.to.split(":")[0]),g=parseInt(r.to.split(":")[1]),b=g+60*y,D=!1,v=0==q-1?7:q-1;if(!(0===y&&0===g)&&b<=h&&r.day===v&&(D=r.day),q===r.day||0===r.day||D===r.day)return b<=h&&(b=g+60*(y+=24)),s=_.range(h,b,1),C=r.rule?_.union(C,s):_.difference(C,s),!0;break;case"time:range":case"custom:daterange":r=r[Y][T][j];var k=parseInt(r.from.split(":")[0]),w=parseInt(r.from.split(":")[1]),x=parseInt(r.to.split(":")[0]),M=parseInt(r.to.split(":")[1]);x<=k&&M<=w&&(x+=24);var I=w+60*k,F=M+60*x;s=_.range(I,F,1),C=r.rule?_.union(C,s):_.difference(C,s)}}catch(O){return!0}}),!_.isEmpty(C)},get_week_number:function(t){var a=new Date(t.getFullYear(),0,1);return Math.ceil(((t-a)/864e5+a.getDay()+1)/7)},has_all_available_staff:function(n){var s=[];return"object"==typeof n&&"object"==typeof n.availability&&(l.each(n.availability,function(t,a){var e=a.level,i=parseInt(a.kind_id);if("staff"!==e||!i)return!0;n.staff_id=i,wc_appointments_date_picker.is_staff_available_on_date(n)||s.push(!1)}),!s.includes(!1))},has_any_available_staff:function(e){var i=[];return"object"==typeof e&&"object"==typeof e.availability&&(l.each(e.has_staff_ids,function(t,a){e.staff_id=a,wc_appointments_date_picker.is_staff_available_on_date(e)&&i.push(!0)}),!!i.includes(!0))},get_format_date:function(t){return t.getFullYear()+"-"+((t.getMonth()+1<10?"0":"")+(t.getMonth()+1))+"-"+((t.getDate()<10?"0":"")+t.getDate())},get_relative_date:function(t){for(var a=new Date,e=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,i=e.exec(t);i;){switch(i[2]||"d"){case"d":case"D":a.setDate(a.getDate()+parseInt(i[1],10));break;case"w":case"W":a.setDate(7*(a.getDate()+parseInt(i[1],10)));break;case"m":case"M":a.setMonth(a.getMonth()+parseInt(i[1],10));break;case"y":case"Y":a.setYear(a.getFullYear()+parseInt(i[1],10))}i=e.exec(t)}return a},find_available_date_within_month:function(){var i=[];return l.each(l(".appointable:not(.ui-state-disabled)").find(".ui-state-default"),function(t,a){var e=+l(a).text();e&&i.push(e)}),i[0]},filter_selectable_day:function(t,a){return t.filter(function(){return Number(l(this).text())===a})}},i=function i(t){this.customPicker=l(t),this.customForm=this.customPicker.closest("form, .cart"),this.customData={},this.opts={cache:!1},this.cache={data:{},attributes:{}},l.each(wc_appointment_form_params,function(t,a){this.customData[t]=a}.bind(this)),!this.customData.cache_ajax_requests||"true"!==this.customData.cache_ajax_requests.toLowerCase()&&"false"!==this.customData.cache_ajax_requests.toLowerCase()||(this.opts.cache="true"===this.customData.cache_ajax_requests.toLowerCase())};i.prototype.create=function(){var t=parseInt(this.customForm.find("input.appointment_date_year").val(),10),a=parseInt(this.customForm.find("input.appointment_date_month").val(),10),e=parseInt(this.customForm.find("input.appointment_date_day").val(),10),s=this.get_default_date();this.customPicker.empty().removeClass("hasDatepicker").datepicker(this.get_default_params()),t&&a&&e&&this.customPicker.datepicker("setDate",new Date(t,a-1,e));var i=this.customPicker.datepicker("getDate").getFullYear(),n=this.customPicker.datepicker("getDate").getMonth()+1;this.get_data(i,n).done(function(){wc_appointments_date_picker.refresh_datepicker()}).done(function(){var t,a,e,i=this.customPicker.attr("data-is_autoselect");if(null===wca_get_querystring("date")&&i||null!==wca_get_querystring("date")&&wca_is_valid_date(wca_get_querystring("date")))if(this.customPicker.datepicker("refresh"),this.customPicker.find(".ui-datepicker-current-day").hasClass("ui-datepicker-unselectable")&&this.customPicker.datepicker("setDate",new Date(s.getFullYear(),s.getMonth()-1,1)),(t=this.customPicker.find(".ui-datepicker-current-day")).hasClass("ui-datepicker-unselectable"))for(var n=1;n<12;n++){if(a=wc_appointments_date_picker.find_available_date_within_month(),0<(e=wc_appointments_date_picker.filter_selectable_day(l(".ui-state-default"),a)).length){e.click();break}this.customPicker.find(".ui-datepicker-next").click()}else t.click();else l(".ui-datepicker-current-day").removeClass("ui-datepicker-current-day")})},i.prototype.maybe_load_from_cache=function(t){var a=t.getTime(),e=[!1,"1"===this.customData.default_availability?"appointable":"not-appointable",""],i=this.cache.attributes[a];if(i)i=[i.selectable,i["class"].join(" "),i.title];else if(this.appointmentsData){var n=new Date(t);n.setHours(HOUR_OFFSET);var s=this.getDateElementAttributes(n);e=[s.selectable,s["class"].join(" "),s.title]}return i||e},i.prototype.get_default_params=function(){return this.defaultParams||{}},i.prototype.set_default_params=function(t){var a={showWeek:!1,showOn:!1,numberOfMonths:1,showButtonPanel:!1,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0,dateFormat:l.datepicker.ISO_8601};if("object"!=typeof t)throw new Error("Cannot set params with typeof "+typeof t);this.defaultParams=l.extend(a,t)||{}},i.prototype.get_data=function(e,i){var n=function n(t){t=t||new Date([e,i,"01"].join("/"));var a=this.get_number_of_days_in_month(i);return this.get_padded_date_range(t,a)}.bind(this),a=l.Deferred(),s=n(),r=s.startDate.getTime()+"-"+s.endDate.getTime();if(H=s,this.opts.cache&&this.cache.data[r])a.resolveWith(this,[s,this.cache.data[r]]);else{var t={"wc-ajax":"wc_appointments_find_scheduled_day_slots",product_id:this.customPicker.attr("data-product_id"),security:this.get_custom_data("nonce_find_day_slots")};this.customPicker.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),t.min_date=moment(s.startDate).format("YYYY-MM-DD"),t.max_date=moment(s.endDate).format("YYYY-MM-DD");var d=0<this.customForm.find("select#wc_appointments_field_staff").val()?this.customForm.find("select#wc_appointments_field_staff").val():0;d&&0!==d&&(t.set_staff_id=d),l.ajax({context:this,url:wc_appointments_date_picker_args.ajax_url,method:"POST",data:t}).done(function(t){this.appointmentsData=this.appointmentsData||{},l.each(t,function(t,a){if(Array.isArray(a)||"object"==typeof a){var e=Array.isArray(a)?[]:{};this.appointmentsData[t]=this.appointmentsData[t]||e,l.extend(this.appointmentsData[t],a)}else this.appointmentsData[t]=a}.bind(this)),o.appointmentsData=this.appointmentsData,this.cache.data[r]=t,e||i||!this.appointmentsData.min_date||(s=n(this.get_default_date(this.appointmentsData.min_date))),a.resolveWith(this,[s,t]),this.customPicker.unblock(),this.customForm.triggerHandler("calendar-data-loaded",[this.appointmentsData,s])}.bind(this))}return a},i.prototype.get_default_date=function(t){var a,e=this.customPicker.data("default_date").split("-");e[2]="31";var i=1;if(a=3!==e.length?new Date:new Date(e),t){switch(t.unit){case"month":i=30;break;case"week":i=7}i*=t.value,a.setDate(a.getDate()+i)}return a},i.prototype.get_number_of_days_in_month=function(t){var a=this.get_default_date();return t=t||a.getMonth()+1,new Date(a.getFullYear(),t,0).getDate()},i.prototype.get_custom_data=function(t){if(t)return this.customData[t]||null},i.prototype.get_data_attr=function(t){if(t)return this.customPicker.data(t)},i.prototype.get_padded_date_range=function(t,a,e){t=t||this.get_default_date(),a=a||30,e=e||7;var i=new Date,n=t<i,s=new Date(t.setDate(n?i.getDate():"01")),r=new Date(s.getTime());return s.setDate(s.getDate()-(n?0:e)),r.setDate(r.getDate()+(a+e)),s<i&&(s=i),{startDate:s,endDate:r}},i.prototype.getDateElementAttributes=function(t){var a={"class":[],title:"",selectable:!0},e=0<this.customForm.find("select#wc_appointments_field_staff").val()?this.customForm.find("select#wc_appointments_field_staff").val():0,i=t.getFullYear(),n=t.getMonth()+1,s=t.getDate(),r=t.getDay(),d=new Date(t),_=new Date,o=_.getFullYear(),c=_.getMonth()+1,p=_.getDate(),l=i+"-"+n+"-"+s,u=this.customPicker.datepicker("option","minDate"),m=wc_appointments_date_picker.get_relative_date(u);if(a["class"].push("weekday-"+r),void 0!==y&&void 0!==g&&(y.setHours(HOUR_OFFSET),g.setHours(HOUR_OFFSET)),y<=t&&t<=g&&a["class"].push("ui-datepicker-selected-day"),wc_appointments_date_picker.get_format_date(d)<wc_appointments_date_picker.get_format_date(m)&&0!==parseInt(u)&&(a.title=wc_appointment_form_params.i18n_date_unavailable,a.selectable=!1,a["class"].push("not_appointable")),this.appointmentsData.unavailable_days&&this.appointmentsData.unavailable_days[l]&&this.appointmentsData.unavailable_days[l][e]&&(a.title=wc_appointment_form_params.i18n_date_unavailable,a.selectable=!1,a["class"].push("not_appointable")),this.appointmentsData.padding_days&&this.appointmentsData.padding_days[l]&&(this.appointmentsData.padding_days[l][0]||this.appointmentsData.padding_days[l][e])&&(a.title=wc_appointment_form_params.i18n_date_unavailable,a.selectable=!1,a["class"].push("not_appointable")),this.appointmentsData.restricted_days&&undefined===this.appointmentsData.restricted_days[r]&&(a.title=wc_appointment_form_params.i18n_date_unavailable,a.selectable=!1,a["class"].push("not_appointable")),""+i+n+s<wc_appointment_form_params.current_time&&(a.title=wc_appointment_form_params.i18n_date_unavailable,a.selectable=!1,a["class"].push("not_appointable")),this.appointmentsData.fully_scheduled_days[l]){if(this.appointmentsData.fully_scheduled_days[l][0]||this.appointmentsData.fully_scheduled_days[l][e])return a.title=wc_appointment_form_params.i18n_date_fully_scheduled,a.selectable=!1,a["class"].push("fully_scheduled"),a;"automatic"===this.appointmentsData.staff_assignment&&a["class"].push("partial_scheduled")}this.appointmentsData.partially_scheduled_days&&this.appointmentsData.partially_scheduled_days[l]&&(("automatic"===this.appointmentsData.staff_assignment||this.appointmentsData.has_staff&&0===e||this.appointmentsData.partially_scheduled_days[l][0]||this.appointmentsData.partially_scheduled_days[l][e])&&a["class"].push("partial_scheduled"),this.appointmentsData.remaining_scheduled_days[l]&&this.appointmentsData.remaining_scheduled_days[l][0]?a["class"].push("remaining_scheduled_"+this.appointmentsData.remaining_scheduled_days[l][0]):this.appointmentsData.remaining_scheduled_days[l]&&this.appointmentsData.remaining_scheduled_days[l][e]&&a["class"].push("remaining_scheduled_"+this.appointmentsData.remaining_scheduled_days[l][e])),new Date(i,n,s)<new Date(o,c,p)&&a["class"].push("past_day");var f={start_date:t,number_of_days:wc_appointments_date_picker.get_number_of_days(this.appointmentsData.appointment_duration,this.customForm,this.customPicker),fully_scheduled_days:this.appointmentsData.fully_scheduled_days,availability:this.appointmentsData.availability_rules,default_availability:this.appointmentsData.default_availability,has_staff:this.appointmentsData.has_staff,has_staff_ids:this.appointmentsData.has_staff_ids,staff_id:e,staff_assignment:this.appointmentsData.staff_assignment},h=wc_appointments_date_picker.is_slot_appointable(f);return h?(-1<a["class"].indexOf("partial_scheduled")?a.title=wc_appointment_form_params.i18n_date_partially_scheduled:-1<a["class"].indexOf("past_day")?a.title=wc_appointment_form_params.i18n_date_unavailable:a.title=wc_appointment_form_params.i18n_date_available,a["class"].push("appointable")):(a.title=wc_appointment_form_params.i18n_date_unavailable,a.selectable=h,0===e?a["class"]=[this.appointmentsData.fully_scheduled_days[l]?"fully_scheduled":"not_appointable"]:this.appointmentsData.fully_scheduled_days[l]&&this.appointmentsData.fully_scheduled_days[l][e]&&(a["class"]=[this.appointmentsData.fully_scheduled_days[l][e]?"fully_scheduled":"not_appointable"])),a},moment.locale(t),(wc_appointments_date_picker=o).init()});